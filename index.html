<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rescue Manager</title>

    <!-- Feuilles de style principales -->
    <link href="main.css" rel="stylesheet" />
    <link
      href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
      rel="stylesheet"
    />
    <link
      href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"
      rel="stylesheet"
    />

    <!-- Librairies JS externes -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  </head>

  <audio
    id="mission-sound"
    src="assets/sounds/sonnerie.mp3"
    preload="auto"
  ></audio>

  <body>
    <!-- ========== CONNEXION & INSCRIPTION ========== -->
    <div id="auth-box" class="auth-container">
      <!-- Formulaire de connexion -->
      <div id="login-form">
        <h3>üîê Connexion joueur</h3>
        <input type="email" id="email" placeholder="Email" />
        <input type="password" id="password" placeholder="Mot de passe" />
        <button onclick="signIn()">Se connecter</button>
        <p>
          Pas encore inscrit ?
          <a href="#" onclick="showSignUp()">Cr√©er un compte</a>
        </p>
      </div>

      <!-- Formulaire d'inscription -->
      <div id="signup-form" class="hidden">
        <h3>üìù Cr√©er un compte</h3>
        <input type="text" id="signup-pseudo" placeholder="Pseudo" />
        <input type="email" id="signup-email" placeholder="Email" />
        <input
          type="password"
          id="signup-password"
          placeholder="Mot de passe"
        />
        <button onclick="signUp()">S'inscrire</button>
        <p>
          D√©j√† inscrit ?
          <a href="#" onclick="showSignIn()">Connexion</a>
        </p>
      </div>
    </div>

    <div id="loader-pois" class="loader-overlay hidden">
      <div class="loader-box">
        <div class="spinner"></div>
        <p>Chargement des points d'int√©r√™t...</p>
      </div>
    </div>

    <!-- ========== INTERFACE DE JEU PRINCIPALE ========== -->
    <div id="game-ui" style="display: none">
      <!-- Barre sup√©rieure avec stats du joueur et boutons -->
      <div id="top-bar">
        <div id="player-info-container">
          <span id="player-info">Niveau: 1 | Argent: 0‚Ç¨</span>

          <div id="xp-block">
            <div id="xp-label">
              <span id="xp-earned">0</span> / <span id="xp-next">0</span>
            </div>
            <div id="xp-bar"><div id="xp-bar-fill"></div></div>
          </div>
        </div>

        <!-- Boutons d'action rapide -->
        <button id="save-btn">üíæ Sauvegarder</button>
        <button class="danger" onclick="resetAllVehiclesToCaserne()">
          üßπ R√©initialiser
        </button>
        <button class="warning" onclick="clearAllVehicleMarkers()">
          ‚ùå Effacer marqueurs
        </button>
        <button id="xp-details-btn">üìà D√©tails XP</button>
        <button id="add-money-btn">üí∏ +1M‚Ç¨</button>
        <button id="clear-missions-btn">‚ùå Supprimer missions</button>
        <button id="open‚Äëstats">üìä Stats</button>
        <button onclick="signOut()" class="danger">üö™ Se d√©connecter</button>

        <!-- Affichage email utilisateur connect√© -->
        <div id="env-info">
          <div class="env-block" id="weather-info">
            <img id="weather-icon" src="assets/weather/sun.png" alt="Soleil" />
            <span id="weather-label">Soleil</span>
          </div>
          <div class="env-block" id="cycle-info">
            <img id="cycle-icon" src="assets/weather/day.png" alt="Jour" />
            <span id="cycle-label">Jour</span>
          </div>
        </div>
      </div>

      <!-- Contenu principal du jeu -->
      <!-- Contenu principal du jeu -->
      <div id="game-container">
        <!-- Panneau Interventions + Log Radio (gauche) -->
        <div id="interventions-container">
          <button id="toggle-interventions">‚¨ÖÔ∏è Fermer</button>

          <div id="missions-panel">
            <h2 class="interventions-header">
              Interventions
              <div class="header-controls">
                <span
                  id="sound-toggle"
                  title="Activer/d√©sactiver le son"
                ></span>
                <span
                  id="mission-toggle"
                  title="D√©sactiver les appels automatiques"
                ></span>
              </div>
            </h2>

            <div id="history-button-wrapper">
              <button onclick="openHistory()">üìú Voir l'historique</button>
            </div>

            <div id="missions-main">
              <div id="calls-quick-actions">
                <button id="open-calls-panel" class="fullwidth">
                  üìû Appels en attente
                  <span id="pending-calls-badge" class="badge">0</span>
                </button>
              </div>

              <!-- (Optionnel) on garde un UL cach√© pour compat r√©tro si du code l‚Äôutilise -->
              <ul id="mission-list" class="hidden"></ul>

              <!-- Log radio en temps r√©el -->
              <div id="radio-log-panel" class="radio-log-panel">
                <div class="radio-log-header">
                  <h3>üìª Log Radio</h3>
                </div>
                <ul id="radio-log-list"></ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Panneau central (carte Leaflet) -->
        <div id="map-container">
          <div id="map-panel">
            <div id="map"></div>

            <!-- Bouton flottant pour ajout de b√¢timent -->
            <button id="add-building-fab" title="Ajouter un b√¢timent">
              <svg width="30" height="30" viewBox="0 0 20 20" fill="none">
                <rect x="9" y="3" width="2" height="14" fill="white" />
                <rect x="3" y="9" width="14" height="2" fill="white" />
              </svg>
            </button>

            <div id="map-notice" class="hidden">
              <span id="map-notice-text"
                >üß± Cliquez sur la carte pour placer</span
              >
              <button id="cancel-placement-btn">Annuler</button>
            </div>
          </div>
        </div>

        <!-- Panneau B√¢timents (droite) -->
        <div id="buildings-container">
          <button id="toggle-buildings">Fermer ‚û°Ô∏è</button>

          <div id="buildings-panel">
            <div id="buildings-header">
              <div id="building-tools">
                <div id="building-filter">
                  <button onclick="filterBuildings('all')">Tous</button>
                  <button onclick="filterBuildings('caserne')">Caserne</button>
                  <button onclick="filterBuildings('hopital')">H√¥pitaux</button>
                  <button onclick="filterBuildings('police')">
                    Commissariats
                  </button>
                </div>

                <button id="toggle-all-vehicles-btn">
                  <svg width="22" height="22" viewBox="0 0 20 20">
                    <path
                      d="M6 8l4-4 4 4M6 12l4 4 4-4"
                      stroke="#333"
                      stroke-width="2"
                      fill="none"
                      stroke-linecap="round"
                    />
                  </svg>
                </button>

                <input
                  type="text"
                  id="building-search"
                  placeholder="üîç Rechercher..."
                />
              </div>
            </div>
            <ul id="building-list"></ul>
          </div>
        </div>
      </div>

      <!-- ========== MODALES ========== -->

      <div id="modal‚Äëstats" class="modal modal-statistics hidden">
        <div class="modal-overlay"></div>
        <div class="modal-content">
          <header>
            <h2>Statistiques</h2>
            <div class="tab-switch">
              <button id="tab‚Äëvehicles" class="active">V√©hicules</button>
              <button id="tab‚Äëbuildings">B√¢timents</button>
            </div>
            <button class="btn secondary" id="close‚Äëstats">Fermer</button>
          </header>
          <div class="stats-container">
            <input
              type="text"
              id="stats-search"
              class="search-input"
              placeholder="Rechercher..."
            />
            <table class="stats-table" id="stats-table">
              <!-- Contenu dynamique -->
            </table>
          </div>
        </div>
      </div>

      <!-- Modale tableau de bord des v√©hicules -->
      <div id="vehicle-board-modal" class="modal hidden">
        <div class="modal-content">
          <h2>Tableau de bord des v√©hicules</h2>
          <ul id="vehicle-board-list"></ul>
          <button onclick="closeVehicleBoardModal()">Fermer</button>
        </div>
      </div>

      <!-- Modale infos v√©hicule -->
      <div id="vehicle-dashboard-modal" class="modal hidden">
        <div class="modal-content">
          <h2 id="veh-title"></h2>
          <p id="veh-stats"></p>
          <p id="veh-missions"></p>
          <p id="veh-wear"></p>
          <button id="veh-maintenance-btn">Envoyer en Maintenance</button>
          <button id="veh-delete-btn">Supprimer le v√©hicule</button>
          <button onclick="closeVehicleDashboard()">Fermer</button>
        </div>
      </div>

      <!-- Modale ajout b√¢timent -->
      <div class="hidden modal-overlay" id="modal">
        <div class="modal-content">
          <h3>Ajouter un b√¢timent</h3>
          <label
            >Type:
            <select id="building-type">
              <option value="cpi">CPI - Centre de Premi√®re Intervention</option>
              <option value="cs">CS - Centre de Secours</option>
              <option value="csp">CSP - Centre de Secours Principal</option>
              <option value="hopital">H√¥pital</option>
              <option value="police">Police</option>
            </select>
          </label>
          <label
            >Nom:
            <input id="building-name" type="text" />
          </label>
          <p id="building-cost-display">Co√ªt : 0‚Ç¨</p>
          <button id="confirm-add-building">Valider</button>
          <button id="cancel-add-building">Annuler</button>
        </div>
      </div>

      <!-- Modale historique -->
      <div id="history-modal" class="hidden modal-overlay">
        <div class="modal-content">
          <h3>Historique des interventions</h3>
          <ul id="history-list" class="history-list"></ul>
          <button onclick="clearHistory()">üóëÔ∏è Vider</button>
          <button onclick="closeHistory()">Fermer</button>
        </div>
      </div>

      <!-- Modale d√©tails XP -->
      <div id="xp-modal" class="hidden modal-overlay">
        <div class="modal-content">
          <h3>D√©tails de l'exp√©rience</h3>
          <p id="xp-current"></p>
          <p id="xp-next"></p>
          <p id="xp-progress"></p>
          <p id="xp-reward"></p>
          <button onclick="closeXpModal()">Fermer</button>
        </div>
      </div>

      <!-- Modale Prise d‚Äôappel -->
      <!-- Panneau plein-√©cran : R√©ception des appels -->
      <div id="calls-panel" class="hidden modal-overlay">
        <div class="modal-content extra-large">
          <button
            class="modal-close close-red"
            aria-label="Fermer"
            title="Fermer"
            onclick="closeCallsPanel()"
          >
            ‚úñ
          </button>

          <div class="calls-header">
            <h2>üìû R√©ception des appels</h2>
            <div class="calls-stats">
              <span>Total :</span>
              <span id="hist-18112" class="chip">Relais 18/112 <b>0</b></span>
              <span id="hist-15" class="chip">Centre 15 <b>0</b></span>
              <span id="hist-17" class="chip">17 <b>0</b></span>
              <span id="hist-total" class="chip strong">Total <b>0</b></span>
            </div>
          </div>

          <div class="calls-table-wrapper">
            <table id="calls-table" class="calls-table">
              <thead>
                <tr>
                  <th>Identifiant</th>
                  <th>Type</th>
                  <th>Provenance</th>
                  <th>Dur√©e d'attente / traitement</th>
                  <th>√âtat</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="calls-tbody"></tbody>
            </table>
          </div>

          <div class="right actions">
            <button id="close-calls-panel">Fermer</button>
          </div>
        </div>
      </div>

      <div id="call-modal" class="hidden modal-overlay">
        <div class="modal-content extra-large">
          <button
            class="modal-close close-red"
            aria-label="Fermer"
            title="Fermer"
            onclick="closeCallModal()"
          >
            ‚úñ
          </button>

          <!-- Encadr√© de prise d'appel (dialogue) -->
          <section class="call-card span-all">
            <header class="call-card-h">Prise d'appel</header>
            <div class="call-row">
              <div id="call-dialogue" class="call-dialogue"></div>
            </div>
          </section>

          <!-- ====== LAYOUT ====== -->
          <div class="call-grid">
            <!-- Col. 1 ‚Äî Carte (plus large) -->
            <section class="call-card" id="call-card-map">
              <header class="call-card-h">Carte</header>
              <div id="call-mini-map"></div>
            </section>

            <!-- Col. 2 ‚Äî Localisation + D√©part & Observations -->
            <section class="call-card" id="call-card-location">
              <header class="call-card-h">Localisation</header>

              <div class="call-row">
                <button
                  id="reveal-address-btn"
                  onclick="handleRevealAddress()"
                  class="btn primary full"
                >
                  üìç Demander l‚Äôadresse
                </button>
              </div>

              <div class="call-row">
                <!-- Texte d'adresse (utilis√© par handleRevealAddress / openCallModal) -->
                <p id="call-address" class=""></p>
              </div>

              <!-- D√©part & Observations (d√©plac√© ici) -->
              <header class="call-card-h" style="margin-top: 6px">
                D√©part & Observations
              </header>
              <div id="depart-type-section" class="">
                <div
                  class="form-row"
                  style="
                    display: flex;
                    gap: 8px;
                    align-items: center;
                    margin: 8px 12px;
                  "
                >
                  <button id="btn-service-pompiers" class="active">
                    üöí Pompiers
                  </button>
                  <button id="btn-service-police">üëÆ Police</button>
                </div>

                <div class="form-row">
                  <label for="select-category"
                    ><strong>Cat√©gorie</strong></label
                  >
                  <select id="select-category">
                    <option value="" selected disabled>
                      Choisir une cat√©gorie‚Ä¶
                    </option>
                  </select>
                </div>

                <div class="form-row">
                  <label for="select-mission"><strong>Mission</strong></label>
                  <select id="select-mission">
                    <option value="" selected disabled>Choisir‚Ä¶</option>
                  </select>
                </div>

                <div class="form-row hidden" id="row-submission">
                  <label for="select-submission"
                    ><strong>Pr√©cision</strong></label
                  >
                  <select id="select-submission">
                    <option value="" selected disabled>Pr√©ciser‚Ä¶</option>
                  </select>
                </div>

                <div class="form-row">
                  <label for="call-observations"
                    ><strong>Observations</strong></label
                  >
                  <textarea
                    id="call-observations"
                    rows="5"
                    placeholder="Notes op√©rateur (optionnel)"
                  ></textarea>
                </div>
              </div>
            </section>

            <!-- Col. 3 ‚Äî V√©hicules -->
            <section class="call-card" id="call-card-vehicles">
              <header class="call-card-h">V√©hicules disponibles</header>

              <div
                id="vehicle-selection-section"
                class="vehicle-selection-context"
              >
                <div id="call-filter-buttons" style="margin: 8px 12px">
                  <button class="filter-btn active" data-filter="ALL">
                    Tous
                  </button>
                  <button class="filter-btn" data-filter="FIRE">Caserne</button>
                  <button class="filter-btn" data-filter="HOSPITAL">
                    H√¥pital
                  </button>
                  <button class="filter-btn" data-filter="POLICE">
                    Commissariat
                  </button>
                </div>

                <div id="vehicle-list"></div>
              </div>
            </section>

            <!-- Col. 4 ‚Äî R√©capitulatif -->
            <section class="call-card" id="call-card-recap">
              <header class="call-card-h">R√©capitulatif</header>
              <div class="recap">
                <div class="recap-row">
                  <span class="recap-k">Identifiant</span>
                  <span class="recap-v" id="recap-id">‚Äî</span>
                </div>
                <div class="recap-row">
                  <span class="recap-k">Cr√©√©e</span>
                  <span class="recap-v" id="recap-ts">‚Äî</span>
                </div>
                <div class="recap-row">
                  <span class="recap-k">Adresse</span>
                  <span class="recap-v" id="recap-address">‚Äî</span>
                </div>
                <!-- Service retir√© comme demand√© -->

                <div class="recap-row">
                  <span class="recap-k">Typologie</span>
                  <span class="recap-v" id="recap-type">‚Äî</span>
                </div>
                <div class="recap-row">
                  <span class="recap-k">V√©hicules</span>
                  <div class="recap-v" id="recap-vehicles">‚Äî</div>
                </div>
                <div class="recap-row">
                  <span class="recap-k">Obs.</span>
                  <div class="recap-v" id="recap-observations">‚Äî</div>
                </div>
              </div>

              <div class="call-row">
                <button id="launch-mission-btn" class="btn success full">
                  üö® D√©clencher l'intervention
                </button>
              </div>
              <div class="call-row">
                <button onclick="closeCallModal()" class="btn secondary full">
                  Annuler
                </button>
              </div>
            </section>
          </div>
          <!-- ====== /LAYOUT ====== -->
        </div>
      </div>

      <!-- Modale renforts -->
      <div id="reinforcement-modal" class="hidden modal-overlay">
        <div class="modal-content large-modal reinforcement-selection-context">
          <h3>üöí Ajouter des renforts</h3>
          <div id="reinforcement-filter-buttons" class="reinforcement-filters">
            <button data-filter="ALL" class="filter-btn active">Tous</button>
            <button data-filter="FIRE" class="filter-btn">Caserne</button>
            <button data-filter="HOSPITAL" class="filter-btn">H√¥pital</button>
            <button data-filter="POLICE" class="filter-btn">
              Commissariat
            </button>
          </div>

          <div id="reinforcement-vehicles"></div>
          <button id="send-reinforcements-btn">‚úÖ Envoyer renforts</button>
          <button onclick="closeReinforcementModal()">Annuler</button>
        </div>
      </div>

      <!-- Modale gestion b√¢timent -->
      <div id="building-modal" class="modal hidden modal-overlay">
        <div class="modal-content scrollable" id="building-modal-content"></div>
      </div>

      <!-- Modale gestion h√¥pital -->
      <div id="hospital-modal" class="hidden modal-overlay">
        <div class="modal-content large-modal">
          <h2>üè• Gestion de l'h√¥pital</h2>
          <div id="hospital-name"></div>
          <ul id="hospital-patient-list" class="patient-list"></ul>
          <button onclick="closeHospitalModal()">Fermer</button>
        </div>
      </div>
    </div>

    <!-- ========== SCRIPTS ========== -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>

    <!-- Modules internes -->

    <script src="save.js"></script>
    <script src="utils.js" defer></script>
    <script src="map.js" defer></script>
    <script src="buildings.js" defer></script>
    <script src="missionTypes.js" defer></script>
    <script src="missions.js"></script>
    <script src="ui.js" defer></script>
  </body>
</html>
