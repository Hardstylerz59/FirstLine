<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rescue Manager</title>

    <!-- Feuilles de style principales -->
    <link href="main.css" rel="stylesheet" />
    <link
      href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
      rel="stylesheet"
    />
    <link
      href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"
      rel="stylesheet"
    />

    <!-- Librairies JS externes -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  </head>

  <audio
    id="mission-sound"
    src="assets/sounds/sonnerie.mp3"
    preload="auto"
  ></audio>

  <body>
    <!-- ========== CONNEXION & INSCRIPTION ========== -->
    <div id="auth-box" class="auth-container">
      <!-- Formulaire de connexion -->
      <div id="login-form">
        <h3>🔐 Connexion joueur</h3>
        <input type="email" id="email" placeholder="Email" />
        <input type="password" id="password" placeholder="Mot de passe" />
        <button onclick="signIn()">Se connecter</button>
        <p>
          Pas encore inscrit ?
          <a href="#" onclick="showSignUp()">Créer un compte</a>
        </p>
      </div>

      <!-- Formulaire d'inscription -->
      <div id="signup-form" class="hidden">
        <h3>📝 Créer un compte</h3>
        <input type="text" id="signup-pseudo" placeholder="Pseudo" />
        <input type="email" id="signup-email" placeholder="Email" />
        <input
          type="password"
          id="signup-password"
          placeholder="Mot de passe"
        />
        <button onclick="signUp()">S'inscrire</button>
        <p>
          Déjà inscrit ?
          <a href="#" onclick="showSignIn()">Connexion</a>
        </p>
      </div>
    </div>

    <div id="loader-pois" class="loader-overlay hidden">
      <div class="loader-box">
        <div class="spinner"></div>
        <p>Chargement des points d'intérêt...</p>
      </div>
    </div>

    <!-- ========== INTERFACE DE JEU PRINCIPALE ========== -->
    <div id="game-ui" style="display: none">
      <!-- Barre supérieure avec stats du joueur et boutons -->
      <div id="top-bar">
        <div id="player-info-container">
          <span id="player-info">Niveau: 1 | Argent: 0€</span>

          <div id="xp-block">
            <div id="xp-label">
              <span id="xp-earned">0</span> / <span id="xp-next">0</span>
            </div>
            <div id="xp-bar"><div id="xp-bar-fill"></div></div>
          </div>
        </div>

        <!-- Boutons d'action rapide -->
        <button id="save-btn">💾 Sauvegarder</button>
        <button class="danger" onclick="resetAllVehiclesToCaserne()">
          🧹 Réinitialiser
        </button>
        <button class="warning" onclick="clearAllVehicleMarkers()">
          ❌ Effacer marqueurs
        </button>
        <button id="xp-details-btn">📈 Détails XP</button>
        <button id="add-money-btn">💸 +1M€</button>
        <button id="clear-missions-btn">❌ Supprimer missions</button>
        <button id="open‑stats">📊 Stats</button>
        <button onclick="signOut()" class="danger">🚪 Se déconnecter</button>

        <!-- Affichage email utilisateur connecté -->
        <div id="env-info">
          <div class="env-block" id="weather-info">
            <img id="weather-icon" src="assets/weather/sun.png" alt="Soleil" />
            <span id="weather-label">Soleil</span>
          </div>
          <div class="env-block" id="cycle-info">
            <img id="cycle-icon" src="assets/weather/day.png" alt="Jour" />
            <span id="cycle-label">Jour</span>
          </div>
        </div>
      </div>

      <!-- Contenu principal du jeu -->
      <!-- Contenu principal du jeu -->
      <div id="game-container">
        <!-- Panneau Interventions + Log Radio (gauche) -->
        <div id="interventions-container">
          <button id="toggle-interventions">⬅️ Fermer</button>

          <div id="missions-panel">
            <h2 class="interventions-header">
              Interventions
              <div class="header-controls">
                <span
                  id="sound-toggle"
                  title="Activer/désactiver le son"
                ></span>
                <span
                  id="mission-toggle"
                  title="Désactiver les appels automatiques"
                ></span>
              </div>
            </h2>

            <div id="history-button-wrapper">
              <button onclick="openHistory()">📜 Voir l'historique</button>
            </div>

            <div id="missions-main">
              <div id="calls-quick-actions">
                <button id="open-calls-panel" class="fullwidth">
                  📞 Appels en attente
                  <span id="pending-calls-badge" class="badge">0</span>
                </button>
              </div>

              <!-- (Optionnel) on garde un UL caché pour compat rétro si du code l’utilise -->
              <ul id="mission-list" class="hidden"></ul>

              <!-- Log radio en temps réel -->
              <div id="radio-log-panel" class="radio-log-panel">
                <div class="radio-log-header">
                  <h3>📻 Log Radio</h3>
                </div>
                <ul id="radio-log-list"></ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Panneau central (carte Leaflet) -->
        <div id="map-container">
          <div id="map-panel">
            <div id="map"></div>

            <!-- Bouton flottant pour ajout de bâtiment -->
            <button id="add-building-fab" title="Ajouter un bâtiment">
              <svg width="30" height="30" viewBox="0 0 20 20" fill="none">
                <rect x="9" y="3" width="2" height="14" fill="white" />
                <rect x="3" y="9" width="14" height="2" fill="white" />
              </svg>
            </button>

            <div id="map-notice" class="hidden">
              <span id="map-notice-text"
                >🧱 Cliquez sur la carte pour placer</span
              >
              <button id="cancel-placement-btn">Annuler</button>
            </div>
          </div>
        </div>

        <!-- Panneau Bâtiments (droite) -->
        <div id="buildings-container">
          <button id="toggle-buildings">Fermer ➡️</button>

          <div id="buildings-panel">
            <div id="buildings-header">
              <div id="building-tools">
                <div id="building-filter">
                  <button onclick="filterBuildings('all')">Tous</button>
                  <button onclick="filterBuildings('caserne')">Caserne</button>
                  <button onclick="filterBuildings('hopital')">Hôpitaux</button>
                  <button onclick="filterBuildings('police')">
                    Commissariats
                  </button>
                </div>

                <button id="toggle-all-vehicles-btn">
                  <svg width="22" height="22" viewBox="0 0 20 20">
                    <path
                      d="M6 8l4-4 4 4M6 12l4 4 4-4"
                      stroke="#333"
                      stroke-width="2"
                      fill="none"
                      stroke-linecap="round"
                    />
                  </svg>
                </button>

                <input
                  type="text"
                  id="building-search"
                  placeholder="🔍 Rechercher..."
                />
              </div>
            </div>
            <ul id="building-list"></ul>
          </div>
        </div>
      </div>

      <!-- ========== MODALES ========== -->

      <div id="modal‑stats" class="modal modal-statistics hidden">
        <div class="modal-overlay"></div>
        <div class="modal-content">
          <header>
            <h2>Statistiques</h2>
            <div class="tab-switch">
              <button id="tab‑vehicles" class="active">Véhicules</button>
              <button id="tab‑buildings">Bâtiments</button>
            </div>
            <button class="btn secondary" id="close‑stats">Fermer</button>
          </header>
          <div class="stats-container">
            <input
              type="text"
              id="stats-search"
              class="search-input"
              placeholder="Rechercher..."
            />
            <table class="stats-table" id="stats-table">
              <!-- Contenu dynamique -->
            </table>
          </div>
        </div>
      </div>

      <!-- Modale tableau de bord des véhicules -->
      <div id="vehicle-board-modal" class="modal hidden">
        <div class="modal-content">
          <h2>Tableau de bord des véhicules</h2>
          <ul id="vehicle-board-list"></ul>
          <button onclick="closeVehicleBoardModal()">Fermer</button>
        </div>
      </div>

      <!-- Modale infos véhicule -->
      <div id="vehicle-dashboard-modal" class="modal hidden">
        <div class="modal-content">
          <h2 id="veh-title"></h2>
          <p id="veh-stats"></p>
          <p id="veh-missions"></p>
          <p id="veh-wear"></p>
          <button id="veh-maintenance-btn">Envoyer en Maintenance</button>
          <button id="veh-delete-btn">Supprimer le véhicule</button>
          <button onclick="closeVehicleDashboard()">Fermer</button>
        </div>
      </div>

      <!-- Modale ajout bâtiment -->
      <div class="hidden modal-overlay" id="modal">
        <div class="modal-content">
          <h3>Ajouter un bâtiment</h3>
          <label
            >Type:
            <select id="building-type">
              <option value="cpi">CPI - Centre de Première Intervention</option>
              <option value="cs">CS - Centre de Secours</option>
              <option value="csp">CSP - Centre de Secours Principal</option>
              <option value="hopital">Hôpital</option>
              <option value="police">Police</option>
            </select>
          </label>
          <label
            >Nom:
            <input id="building-name" type="text" />
          </label>
          <p id="building-cost-display">Coût : 0€</p>
          <button id="confirm-add-building">Valider</button>
          <button id="cancel-add-building">Annuler</button>
        </div>
      </div>

      <!-- Modale historique -->
      <div id="history-modal" class="hidden modal-overlay">
        <div class="modal-content">
          <h3>Historique des interventions</h3>
          <ul id="history-list" class="history-list"></ul>
          <button onclick="clearHistory()">🗑️ Vider</button>
          <button onclick="closeHistory()">Fermer</button>
        </div>
      </div>

      <!-- Modale détails XP -->
      <div id="xp-modal" class="hidden modal-overlay">
        <div class="modal-content">
          <h3>Détails de l'expérience</h3>
          <p id="xp-current"></p>
          <p id="xp-next"></p>
          <p id="xp-progress"></p>
          <p id="xp-reward"></p>
          <button onclick="closeXpModal()">Fermer</button>
        </div>
      </div>

      <!-- Modale Prise d’appel -->
      <!-- Panneau plein-écran : Réception des appels -->
      <div id="calls-panel" class="hidden modal-overlay">
        <div class="modal-content extra-large">
          <button
            class="modal-close close-red"
            aria-label="Fermer"
            title="Fermer"
            onclick="closeCallsPanel()"
          >
            ✖
          </button>

          <div class="calls-header">
            <h2>📞 Réception des appels</h2>
            <div class="calls-stats">
              <span>Total :</span>
              <span id="hist-18112" class="chip">Relais 18/112 <b>0</b></span>
              <span id="hist-15" class="chip">Centre 15 <b>0</b></span>
              <span id="hist-17" class="chip">17 <b>0</b></span>
              <span id="hist-total" class="chip strong">Total <b>0</b></span>
            </div>
          </div>

          <div class="calls-table-wrapper">
            <table id="calls-table" class="calls-table">
              <thead>
                <tr>
                  <th>Identifiant</th>
                  <th>Type</th>
                  <th>Provenance</th>
                  <th>Durée d'attente / traitement</th>
                  <th>État</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="calls-tbody"></tbody>
            </table>
          </div>

          <div class="right actions">
            <button id="close-calls-panel">Fermer</button>
          </div>
        </div>
      </div>

      <div id="call-modal" class="hidden modal-overlay">
        <div class="modal-content extra-large">
          <button
            class="modal-close close-red"
            aria-label="Fermer"
            title="Fermer"
            onclick="closeCallModal()"
          >
            ✖
          </button>

          <!-- Encadré de prise d'appel (dialogue) -->
          <section class="call-card span-all">
            <header class="call-card-h">Prise d'appel</header>
            <div class="call-row">
              <div id="call-dialogue" class="call-dialogue"></div>
            </div>
          </section>

          <!-- ====== LAYOUT ====== -->
          <div class="call-grid">
            <!-- Col. 1 — Carte (plus large) -->
            <section class="call-card" id="call-card-map">
              <header class="call-card-h">Carte</header>
              <div id="call-mini-map"></div>
            </section>

            <!-- Col. 2 — Localisation + Départ & Observations -->
            <section class="call-card" id="call-card-location">
              <header class="call-card-h">Localisation</header>

              <div class="call-row">
                <button
                  id="reveal-address-btn"
                  onclick="handleRevealAddress()"
                  class="btn primary full"
                >
                  📍 Demander l’adresse
                </button>
              </div>

              <div class="call-row">
                <!-- Texte d'adresse (utilisé par handleRevealAddress / openCallModal) -->
                <p id="call-address" class=""></p>
              </div>

              <!-- Départ & Observations (déplacé ici) -->
              <header class="call-card-h" style="margin-top: 6px">
                Départ & Observations
              </header>
              <div id="depart-type-section" class="">
                <div
                  class="form-row"
                  style="
                    display: flex;
                    gap: 8px;
                    align-items: center;
                    margin: 8px 12px;
                  "
                >
                  <button id="btn-service-pompiers" class="active">
                    🚒 Pompiers
                  </button>
                  <button id="btn-service-police">👮 Police</button>
                </div>

                <div class="form-row">
                  <label for="select-category"
                    ><strong>Catégorie</strong></label
                  >
                  <select id="select-category">
                    <option value="" selected disabled>
                      Choisir une catégorie…
                    </option>
                  </select>
                </div>

                <div class="form-row">
                  <label for="select-mission"><strong>Mission</strong></label>
                  <select id="select-mission">
                    <option value="" selected disabled>Choisir…</option>
                  </select>
                </div>

                <div class="form-row hidden" id="row-submission">
                  <label for="select-submission"
                    ><strong>Précision</strong></label
                  >
                  <select id="select-submission">
                    <option value="" selected disabled>Préciser…</option>
                  </select>
                </div>

                <div class="form-row">
                  <label for="call-observations"
                    ><strong>Observations</strong></label
                  >
                  <textarea
                    id="call-observations"
                    rows="5"
                    placeholder="Notes opérateur (optionnel)"
                  ></textarea>
                </div>
              </div>
            </section>

            <!-- Col. 3 — Véhicules -->
            <section class="call-card" id="call-card-vehicles">
              <header class="call-card-h">Véhicules disponibles</header>

              <div
                id="vehicle-selection-section"
                class="vehicle-selection-context"
              >
                <div id="call-filter-buttons" style="margin: 8px 12px">
                  <button class="filter-btn active" data-filter="ALL">
                    Tous
                  </button>
                  <button class="filter-btn" data-filter="FIRE">Caserne</button>
                  <button class="filter-btn" data-filter="HOSPITAL">
                    Hôpital
                  </button>
                  <button class="filter-btn" data-filter="POLICE">
                    Commissariat
                  </button>
                </div>

                <div id="vehicle-list"></div>
              </div>
            </section>

            <!-- Col. 4 — Récapitulatif -->
            <section class="call-card" id="call-card-recap">
              <header class="call-card-h">Récapitulatif</header>
              <div class="recap">
                <div class="recap-row">
                  <span class="recap-k">Identifiant</span>
                  <span class="recap-v" id="recap-id">—</span>
                </div>
                <div class="recap-row">
                  <span class="recap-k">Créée</span>
                  <span class="recap-v" id="recap-ts">—</span>
                </div>
                <div class="recap-row">
                  <span class="recap-k">Adresse</span>
                  <span class="recap-v" id="recap-address">—</span>
                </div>
                <!-- Service retiré comme demandé -->

                <div class="recap-row">
                  <span class="recap-k">Typologie</span>
                  <span class="recap-v" id="recap-type">—</span>
                </div>
                <div class="recap-row">
                  <span class="recap-k">Véhicules</span>
                  <div class="recap-v" id="recap-vehicles">—</div>
                </div>
                <div class="recap-row">
                  <span class="recap-k">Obs.</span>
                  <div class="recap-v" id="recap-observations">—</div>
                </div>
              </div>

              <div class="call-row">
                <button id="launch-mission-btn" class="btn success full">
                  🚨 Déclencher l'intervention
                </button>
              </div>
              <div class="call-row">
                <button onclick="closeCallModal()" class="btn secondary full">
                  Annuler
                </button>
              </div>
            </section>
          </div>
          <!-- ====== /LAYOUT ====== -->
        </div>
      </div>

      <!-- Modale renforts -->
      <div id="reinforcement-modal" class="hidden modal-overlay">
        <div class="modal-content large-modal reinforcement-selection-context">
          <h3>🚒 Ajouter des renforts</h3>
          <div id="reinforcement-filter-buttons" class="reinforcement-filters">
            <button data-filter="ALL" class="filter-btn active">Tous</button>
            <button data-filter="FIRE" class="filter-btn">Caserne</button>
            <button data-filter="HOSPITAL" class="filter-btn">Hôpital</button>
            <button data-filter="POLICE" class="filter-btn">
              Commissariat
            </button>
          </div>

          <div id="reinforcement-vehicles"></div>
          <button id="send-reinforcements-btn">✅ Envoyer renforts</button>
          <button onclick="closeReinforcementModal()">Annuler</button>
        </div>
      </div>

      <!-- Modale gestion bâtiment -->
      <div id="building-modal" class="modal hidden modal-overlay">
        <div class="modal-content scrollable" id="building-modal-content"></div>
      </div>

      <!-- Modale gestion hôpital -->
      <div id="hospital-modal" class="hidden modal-overlay">
        <div class="modal-content large-modal">
          <h2>🏥 Gestion de l'hôpital</h2>
          <div id="hospital-name"></div>
          <ul id="hospital-patient-list" class="patient-list"></ul>
          <button onclick="closeHospitalModal()">Fermer</button>
        </div>
      </div>
    </div>

    <!-- ========== SCRIPTS ========== -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>

    <!-- Modules internes -->

    <script src="save.js"></script>
    <script src="utils.js" defer></script>
    <script src="map.js" defer></script>
    <script src="buildings.js" defer></script>
    <script src="missionTypes.js" defer></script>
    <script src="missions.js"></script>
    <script src="ui.js" defer></script>
  </body>
</html>
